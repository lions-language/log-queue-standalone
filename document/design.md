## 目标
### 功能
- 向topic中写入数据, 并持久化
- 消费者可以决定从哪里开始消费
    - 从上一次读取到的位置开始消费
    - 从头开始消费
    - 从最新的开始消费
- 多个消费者共同消费同一个 topic

### 集群
- 单节点写入, 如果写入节点崩溃, 将存在一定时间的 不可用


## 实现
### 消息的写入
#### 概述
- 为每一个topic创建一个目录
    - 存储数据
- 在topic的目录中, 将写入topic的数据记录到文件中
- 每个文件中存储多个数据 (head + body)
    - 一般来说, 读取文件的时候, 每次读取 一个页大小, 便于读取的时候可以完全加载到内存页中 (避免跨页访问)
- topic目录中的日志文件使用 的第一条数据的 offset 命名

#### 文件查找
- 对所有的文件建立 索引
- 输入 整体索引, 通过对索引的快速查找(二分查找), 定位到文件名

#### 文件中查找消息
- 为每个 数据文件 都建立一个 索引文件, 索引文件中记录 消息的相对位置 和 文件的实际偏移 之间的映射关系
    - 索引的查找可以使用 二分查找
- 索引文件的查找
    - 索引项的大小是固定的 (8字节)
    - 可以通过传入的 索引项的 index, 定位到索引项的实际位置
- 如果查找方知道 即将读取的 相对偏移, 那么就可以通过这个索引表, 找到对应的 文件中的实际偏移

### 消息读取的另外一种方式
- 直接写在文件的末端
- 每次读取的时候, 获取到消息的位置offset 并返回给client, client可以选择保留这个 offset, 然后从指定的位置读起
- 问题
    - 主要要处理操作系统写入磁盘失败后, 导致文件数据错乱问题
- 解决文件错乱 方案一
    - 添加校验位
    - 主备模式, 如果主检测到错误, 就向 备 索取, 如果都错误, 那只能截断这部分错误的数据
        - 如何截断?截断多少?
            - 可以通过 索引 来减少消息丢失的情况: 根据索引, 快速找到下一条消息
- 解决文件错乱 方案二
    - 添加 水位机制, 水位线之前的 表示的是已经成功落盘的, 之后的, 表示的是还没有落盘的
        - 可以通过副本机制, 保证消息有多个备份, 当指定数量的副本接收到数据后, 移动水位线, 水位线之前的表示是已经做了备份了, 水位线之后的, 表示还没有备份, 这种没有备份的消息将被抛弃
    - 当检测到错乱后, 截取掉水位线之后的所有消息, 保证文件的准确性


## 阶段1
### 日志结构
- 一端写入, 记录消息的位移(next 写入的位置)
    - 无索引文件
- 利用水位线机制 和 备份机制, 防止数据丢失(错乱)

### 请求处理
- 监控指标的记录
- 


